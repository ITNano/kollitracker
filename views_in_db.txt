CREATE VIEW workhours AS SELECT W.user_id AS user_id, W.lager_id AS lager_id, W.date AS date, ((SELECT SUM(TIME_TO_SEC(TIMEDIFF(W2.end, W2.start))) FROM workday W2 WHERE W2.date = W.date AND W2.lager_id = W.lager_id)-(SELECT SUM(TIME_TO_SEC(TIMEDIFF(B.end, B.start))) FROM breaks B WHERE B.date = W.date AND B.start >= W.start AND B.end <= W.end))/3600 AS hours FROM workday W GROUP BY date, lager_id ORDER BY date
CREATE VIEW currentplock AS SELECT user_id, lager_id, DATE(stamp) AS date, TIME(stamp) AS time, MAX(kolli) AS kolli FROM plock GROUP BY DATE(stamp),lager_id
CREATE VIEW dayprogress AS SELECT W.user_id AS user_id, W.lager_id AS lager_id, W.date AS date, ElapsedTime(W.date, W.start, W.end)-SUM(ElapsedTime(B.date, B.start, B.end)) as time FROM workday W LEFT JOIN breaks B ON W.date = B.date AND B.start >= W.start AND B.end <= W.end GROUP BY W.date,lager_id


DROP FUNCTION IF EXISTS ElapsedTime;
DELIMITER $$
CREATE FUNCTION ElapsedTime( date DATE, start TIME, end TIME )
RETURNS FLOAT

BEGIN
    IF CURDATE() = date THEN
        RETURN GREATEST(0, LEAST(TIME_TO_SEC(TIMEDIFF(CURTIME(), start)), TIME_TO_SEC(TIMEDIFF(end, start))))/3600;
    ELSEIF CURDATE() < date THEN
        RETURN 0;
    ELSE
        RETURN TIME_TO_SEC(TIMEDIFF(end, start))/3600;
    END IF;
END;$$
DELIMITER ;



DROP FUNCTION IF EXISTS IsThisWeek;
DELIMITER $$
CREATE FUNCTION IsThisWeek( date DATE )
RETURNS BOOL

BEGIN
    RETURN WEEK(date, 1) = WEEK(CURDATE(), 1);
END;$$
DELIMITER ;



DROP FUNCTION IF EXISTS IsToday;
DELIMITER $$
CREATE FUNCTION IsToday( date DATE )
RETURNS BOOL

BEGIN
    RETURN date = CURDATE();
END;$$
DELIMITER ;